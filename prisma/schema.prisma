// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String      @id @default(cuid())
  email        String      @unique
  passwordHash String
  createdAt    DateTime    @default(now())
  scans        Scan[]
  orgMembers   OrgMember[]
  alertSettings AlertSettings?
}

model Organization {
  id          String      @id @default(cuid())
  name        String
  slug        String      @unique
  createdAt   DateTime    @default(now())
  members     OrgMember[]
  scans       Scan[]
  schedules   ScanSchedule[]
  alertRules  AlertRule[]
}

model OrgMember {
  id             String       @id @default(cuid())
  userId         String
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  orgId          String
  organization   Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  role           OrgRole      @default(MEMBER)
  createdAt      DateTime     @default(now())
  
  @@unique([userId, orgId])
}

enum OrgRole {
  OWNER
  ADMIN
  MEMBER
}

model Scan {
  id          String    @id @default(cuid())
  userId      String?
  user        User?     @relation(fields: [userId], references: [id], onDelete: Cascade)
  orgId       String?
  organization Organization? @relation(fields: [orgId], references: [id], onDelete: Cascade)
  url         String
  riskScore   Int
  riskLevel   RiskLevel
  status      ScanStatus @default(PENDING)
  scanType    ScanType  @default(STANDARD)
  progress    Int       @default(0) // 0-100
  startedAt   DateTime  @default(now())
  completedAt DateTime?
  duration    Int?      // Duration in seconds
  findings    Finding[]
  scheduleId  String?
  schedule    ScanSchedule? @relation(fields: [scheduleId], references: [id], onDelete: SetNull)
}

model Finding {
  id       String      @id @default(cuid())
  scanId   String
  scan     Scan        @relation(fields: [scanId], references: [id], onDelete: Cascade)
  type     FindingType
  title    String
  severity Severity
  passed   Boolean
  details  String?     @db.Text
}

enum RiskLevel {
  LOW
  MEDIUM
  HIGH
}

enum ScanStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
}

enum ScanType {
  QUICK
  STANDARD
  DEEP
  CUSTOM
}

enum FindingType {
  HEADER
  SSL
  PORT
  XSS
  OTHER
}

enum Severity {
  INFO
  LOW
  MEDIUM
  HIGH
}

model ScanSchedule {
  id          String    @id @default(cuid())
  orgId       String?
  organization Organization? @relation(fields: [orgId], references: [id], onDelete: Cascade)
  userId      String
  url         String
  frequency   String    // e.g., "daily", "weekly", "monthly", or cron expression
  cron        String?   // Optional cron expression
  active      Boolean   @default(true)
  createdAt   DateTime  @default(now())
  lastRunAt   DateTime?
  nextRunAt  DateTime?
  scans       Scan[]
}

model AlertRule {
  id          String    @id @default(cuid())
  orgId       String
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  userId      String
  url         String?   // Optional: null means all URLs in org
  minRisk     RiskLevel @default(MEDIUM)
  email       String
  active      Boolean   @default(true)
  createdAt   DateTime  @default(now())
}

model AlertSettings {
  id          String    @id @default(cuid())
  userId      String    @unique
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  enabled     Boolean   @default(true)
  minRisk     RiskLevel @default(MEDIUM)
  email       String
  updatedAt   DateTime  @default(now()) @updatedAt
}

